<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Item Dashboard</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"  rel="stylesheet" />

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f4f4f4, #a8cbf4);
    }

    
    .sidebar {
      height: 100vh;
      position: fixed;
      width: 220px;
      background-color: #1c1f1f;
      padding-top: 20px;
    }

    .sidebar a {
      display: block;
      color: #ddd;
      padding: 10px 20px;
      text-decoration: none;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #495057;
      color: white;
    }

    

  
    .main-content {
      margin-left: 230px; 
      padding: 20px;
    }

    .top-navbar {
  position: fixed;
  top: 0;
  left: 220px;
  right: 0;
  height: 50px;
  background-color: #1c8eff;
  border-bottom: 1px solid #ddd;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  z-index: 1000;
}

    .main-content {
      padding-top: 70px; 
    }

    .user-info {
      font-weight: bold;
      color: #0c0404;
      margin-right: 15px;
    }

    .nested-table {
      margin: 10px 0;
    }

    #notificationCount {
      position: relative;
      top: -10px;
      left: -5px;
      font-size: 10px;
      padding: 3px 6px;
    }

    .sidebar-collapsed .sidebar {
  width: 0;
  overflow: hidden;
  transition: width 0.3s ease;
}

.sidebar-collapsed .main-content {
  margin-left: 0;
  transition: margin-left 0.3s ease;
}

.sidebar-collapsed .top-navbar {
  left: 0;
  transition: left 0.3s ease;
}

.toggle-sidebar-icon {
  background: none;
  border: none;
  color: white;
  font-size: 22px;
  cursor: pointer;
  outline: none;
}

.toggle-sidebar-icon:hover {
  color: #d1eaff;
}

  </style>
</head>

<body>

  <div class="sidebar">
    <ul>
      <li><a href="/item-groups">Item Groups</a></li>
      <li><a href="/sales-orders">Sales Orders</a></li>
      <li><a href="/packages">Packages</a></li>
      <li><a href="/invoices">Invoices</a></li>
      <li><a href="/purchase-orders">Purchase Orders</a></li>
      <li><a href="/bills">Bills</a></li>
      <li><a href="/integrations">Integrations</a></li>
      <li><a href="{{ url_for('report') }}">Reports</a></li>
      <li><a href="/contacts">Contacts</a></li>
    </ul>
  </div>

<div class="top-navbar">
  <div style="display: flex; align-items: center;">
    <button class="toggle-sidebar-icon mr-3" onclick="toggleSidebar()">â˜°</button>
    <h4 style="margin: 0; color: white;">Item Dashboard</h4>
  </div>

  <div style="display: flex; align-items: center; gap: 10px;">
  
    <div class="dropdown">
      <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="notificationDropdown"
        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span id="notificationCount" class="badge badge-danger">0</span>
      </button>
      <div class="dropdown-menu dropdown-menu-right" style="width: 300px;" aria-labelledby="notificationDropdown">
        <h6 class="dropdown-header">Notifications</h6>
        <div id="notificationList">
          <p class="dropdown-item text-center text-muted" id="noNotifications">No new notifications</p>
        </div>
      </div>
    </div>

    {% if session.get('username') %}
    <span style="color: rgb(0, 0, 0);">Logged in as: <strong>{{ session['username'] }}</strong></span>
    {% endif %}

    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
  </div>
</div>


  <div class="main-content">

    <div class="header mb-4">
      <h2>Item Dashboard</h2>
    </div>

    <a href="#" data-toggle="modal" data-target="#addItemModal"
      class="btn btn-primary mb-3">Add New Item</a>

    <table class="table table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Item Name</th>
          <th>Total Quantity</th>
          <th>Total Price</th>
          <th>Item Quantity</th>
          <th>Item Price</th>
          <th>Total</th>
          <th>Actions</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
        <tr>
          <td>{{ row[1] }}</td>
          <td>{{ row[2] }}</td>
          <td>{{ row[3] }}</td>
          <td>{{ row[4] }}</td>
          <td>{{ row[5] }}</td>
          <td>{{ row[6] }}</td>
          <td>
            <a href="{{ url_for('update_item', itemid=row[0]) }}" class="btn btn-warning btn-sm">Edit</a>
            <a href="{{ url_for('delete_item', itemid=row[0]) }}" class="btn btn-danger btn-sm">Delete</a>
          </td>
          <td>
            <button class="btn btn-info btn-sm" data-toggle="collapse" data-target="#nestedGrid{{ row[0] }}">
              Toggle Details
            </button>
          </td>
        </tr>

        <tr id="nestedGrid{{ row[0] }}" class="collapse">
          <td colspan="8">
            <table class="table table-bordered nested-table">
              <thead>
                <tr>
                  <th>Item Detail Name</th>
                  <th>Item Detail Quantity</th>
                  <th>Item Detail Price</th>
                  <th>Item Total</th>
                </tr>
              </thead>
              <tbody>
                {% for detail in row.details %}
                <tr>
                  <td>{{ detail.name }}</td>
                  <td>{{ detail.quantity }}</td>
                  <td>{{ detail.price }}</td>
                  <td>{{ detail.total }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <nav style="background-color: #282b2d; padding: 10px;">
      <a href="/" style="color: rgb(168, 41, 41); margin-right: 20px; text-decoration: none;">Home</a>
      <a href="/dashboard" style="color: white; text-decoration: none;">Dashboard</a>
    </nav>

    <div class="row mt-4">
      <div class="col-md-2">
        <div class="card text-center p-3">
          <h3>25</h3>
          <p>Packages</p>
          <small>TO BE PACKED</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3">
          <h3>8</h3>
          <p>Pkgs</p>
          <small>TO BE SHIPPED</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3">
          <h3>6</h3>
          <p>Pkgs</p>
          <small>DISPATCHED</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3">
          <h3>2</h3>
          <p>Pkgs</p>
          <small>OUT FOR DELIVERY</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center p-3">
          <h3>5</h3>
          <p>Pkgs</p>
          <small>DELIVERED</small>
        </div>
      </div>
    </div>

  </div>


  <div class="modal" id="addItemModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Add Item</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('add_item') }}" method="POST">
            <div class="form-group">
              <label for="itemname">Item Name</label>
              <input type="text" class="form-control" id="itemname" name="itemname" required />
            </div>
            <div class="form-group">
              <label for="totalqty">Total Quantity</label>
              <input type="number" class="form-control" id="totalqty" name="totalqty" required />
            </div>
            <div class="form-group">
              <label for="totalprice">Total Price</label>
              <input type="number" class="form-control" id="totalprice" name="totalprice" required />
            </div>
            <div class="form-group">
              <label for="itemqty">Item Quantity</label>
              <input type="number" class="form-control" id="itemqty" name="itemqty" required />
            </div>
            <div class="form-group">
              <label for="itemprice">Item Price</label>
              <input type="number" class="form-control" id="itemprice" name="itemprice" required />
            </div>
            <button type="submit" class="btn btn-primary">Add Item</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script> 
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> 

  {% if session.get('username') %}
  <script>
    
    localStorage.setItem('loggedInUser', '{{ session["username"] }}');
  </script>

  <a href="{{ url_for('report') }}" class="btn btn-secondary mt-3" style="margin-left: 230px;">
    Go to Reports
  </a>
  {% endif %}

  
<script>
const itemNames = {
  1: "One Plus Nord Ce 2 Lite 5g",
  2: "Samsung 8k Tv",
  3: "Lenovo Idea pad 3",
  4: "Samsung Washing Machine (Front load)",
  5: "Blue Star 1.5 Ton Inverter Ac",
  6: "LG 1.5 Ton AC",
  7: "LG Smart TV AC",
  8: "Apple iPhone 12, 256 GB, Cherry Red",
  9: "Mouse"
};

const stockLedgerHistory = {
  1: [
    { date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock", expiryDate: "2025-12-31" },
    { date: "2025-05-10", type: "Sale", qty: -10, remarks: "Sold 10 units" }
  ],
  2: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock", expiryDate: "2025-06-30" }],
  3: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  4: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  5: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  6: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  7: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  8: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }],
  9: [{ date: "2025-05-01", type: "Opening Balance", qty: 100, remarks: "Initial Stock" }]
};

const stockLedger = Object.entries(stockLedgerHistory).map(([id, history]) => {
  const opening = history.find(h => h.type === "Opening Balance")?.qty || 0;
  const changes = history.reduce((sum, h) => h.type !== "Opening Balance" ? sum + h.qty : sum, 0);
  return {
    stockLedgerId: parseInt(id),
    itemName: itemNames[id] || `Item ${id}`,
    openingBalance: opening,
    currentQty: opening + changes,
    stockLedgerNumber: `SL-${id}`
  };
});

function createHistoryTable(history) {
  let html = `<table class="nested-table">
    <thead><tr><th>Date</th><th>Transaction Type</th><th>Quantity</th><th>Remarks</th></tr></thead><tbody>`;
  history.forEach(h => {
    html += `<tr><td>${h.date}</td><td>${h.type}</td><td>${h.qty}</td><td>${h.remarks}</td></tr>`;
  });
  html += "</tbody></table>";
  return html;
}

function renderTable() {
  const tbody = document.querySelector("#stockLedgerTable tbody");
  tbody.innerHTML = "";

  stockLedger.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.itemName}</td>
      <td>${item.openingBalance}</td>
      <td>${item.currentQty}</td>
      <td>${item.stockLedgerNumber}</td>
      <td><button class="toggle-btn">Show History</button></td>`;
    tbody.appendChild(tr);

    const histTr = document.createElement("tr");
    histTr.classList.add("history-row");
    histTr.style.display = "none";
    const td = document.createElement("td");
    td.colSpan = 4;
    td.innerHTML = createHistoryTable(stockLedgerHistory[item.stockLedgerId]);
    histTr.appendChild(td);
    tbody.appendChild(histTr);

    const btn = tr.querySelector(".toggle-btn");
    btn.addEventListener("click", () => {
      if (histTr.style.display === "none") {
        histTr.style.display = "table-row";
        btn.textContent = "Hide History";
      } else {
        histTr.style.display = "none";
        btn.textContent = "Show History";
      }
    });
  });
}


function loadContent(section) {
  switch (section) {
    case 'totalBills':
      window.location.href = '/bills';
      break;
    case 'billsPerMonth':
      window.location.href = '/reports-overview';
      break;
    case 'itemsSold':
      window.location.href = '/invoices';
      break;
    default:
      alert(`You clicked: ${section}`);
  }
}

function logout() {
  
  window.location.href = '/login';
}

function toggleSidebar() {
  document.body.classList.toggle("sidebar-collapsed");S
}

function scrollToForm() {
  document.getElementById("addItemForm").scrollIntoView({ behavior: "smooth" });
}

document.getElementById("itemForm").addEventListener("input", () => {
  document.getElementById("saveBtn").disabled = !itemForm.checkValidity();
});

function handleSave(event) {
  event.preventDefault();
  const name = document.getElementById('itemName').value;
  const opening = parseInt(document.getElementById('openingBalance').value);
  const qty = parseInt(document.getElementById('currentQty').value);
  const newId = Object.keys(stockLedgerHistory).length + 1;
  stockLedgerHistory[newId] = [
    { date: new Date().toISOString().split('T')[0], type: "Opening Balance", qty: opening, remarks: "Initial Stock" }
  ];
  stockLedger.push({
    stockLedgerId: newId,
    itemName: name,
    openingBalance: opening,
    currentQty: qty,
    stockLedgerNumber: `SL-${newId}`
  });
  itemNames[newId] = name;
  renderTable();
  itemForm.reset();
  saveBtn.disabled = true;
}

renderTable();


function loadNotifications(notifications) {
  const list = $('#notificationList');
  const countBadge = $('#notificationCount');
  const noNoteText = $('#noNotifications');

  list.empty();

  if (!notifications || notifications.length === 0) {
    noNoteText.show();
    countBadge.text("0");
    return;
  }

  noNoteText.hide();
  countBadge.text(notifications.length);

  notifications.forEach(note => {
    const url = `http://127.0.0.1:5006/stock_ledger?itemId=${note.itemId}`;
    let message = note.message;

    
    if (note.expiryDate) {
      message += ` (Expires on ${note.expiryDate})`;
    }

   
    const itemDetails = stockLedger.find(item => item.stockLedgerId === note.itemId);
    if (itemDetails) {
      const itemName = itemDetails.itemName;
      const stockLedgerNumber = itemDetails.stockLedgerNumber;

      
      message = `${message} | Item Name: ${itemName} | Stock Ledger Number: ${stockLedgerNumber}`;
    }

    const item = $(`<a class="dropdown-item" href="${url}">${message}</a>`);
    list.append(item);
  });
}

$(document).ready(function () {
  
  const mockNotifications = [
    { message: "Item Laptop has low stock.", itemId: 1, expiryDate: "2025-12-31" },
    { message: "Item Mouse is nearing expiry.", itemId: 2, expiryDate: "2025-06-30" }
  ];

  loadNotifications(mockNotifications);
});
</script>
</script>
<script>
  function toggleSidebar() {
    document.body.classList.toggle("sidebar-collapsed");
  }
</script>

  <div class="footer">
    &copy; 2025 Inventory Management Dashboard. All rights reserved.
  </div>

</body>
</html>
