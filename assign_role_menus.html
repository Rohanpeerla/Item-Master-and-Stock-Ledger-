<!DOCTYPE html>
<html>
<head>
  <title>Role-Menu Assignment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #1850a4;
      display: flex;
    }

    /* Hide sidebar */
    .sidebar {
      width: 220px;
      background-color: #343a40;
      color: white;
      height: 100vh;
      padding-top: 20px;
      position: fixed;
      top: 0;
      left: -220px; /* Hidden */
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 1000;
    }

    /* Sidebar visible */
    .sidebar.visible {
      left: 0;
    }

    .sidebar h2 {
      color: #fff;
      font-size: 18px;
      text-align: center;
      margin-bottom: 20px;
    }

    .sidebar a {
      color: #cfd8dc;
      padding: 10px 20px;
      text-decoration: none;
      display: block;
    }

    .sidebar a:hover {
      background-color: #495057;
    }

    .main-content {
      margin-left: 0; /* Because sidebar hidden */
      padding: 0 20px;
      flex: 1;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    .main-content.shifted {
      margin-left: 220px; /* When sidebar shown */
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #3b79ff;
      padding: 10px 20px;
      border-bottom: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

 .sidebar-toggle {
  font-size: 24px;
  background: none;
  border: none;
  cursor: pointer;
  color: #ffffff; /* ✅ White */
  padding: 0;
  user-select: none;
}



    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      font-weight: bold;
      color: #333;
    }

    header button.logout-btn {
      padding: 6px 12px;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    header button.logout-btn:hover {
      background-color: #c9302c;
    }

    h2 {
      margin-bottom: 10px;
      color: #333;
    }

    select, input[type="text"], input[type="number"], input[type="email"], input[type="tel"] {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 250px;
      display: block;
    }

    ul, li {
      list-style-type: none;
      margin: 5px 0;
    }

    #menuTree {
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .menu-item {
      margin-left: 25px;
      display: none;
    }

    .access-rights {
      margin-left: 10px;
      display: inline-block;
    }

    .access-rights label {
      margin-right: 10px;
      font-size: 13px;
    }

    footer {
      background-color: #ffffff;
      padding: 10px 20px;
      text-align: center;
      border-top: 1px solid #ccc;
      font-size: 13px;
      color: #666;
      margin-top: 30px;
    }

    .top-section {
      margin-top: 30px;
      max-width: 800px;
    }

    button.save-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
    }

    button.save-btn:disabled {
      background-color: #a9d6a3;
      cursor: not-allowed;
    }

    #expandCollapseControls {
      margin-bottom: 15px;
    }

    #expandCollapseControls button {
      margin-right: 10px;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    #expandCollapseControls button:hover {
      background-color: #0056b3;
    }

    .toggle-btn {
      cursor: pointer;
      font-weight: bold;
      margin-right: 6px;
      color: #ffffff;
      user-select: none;
    }

    .toggle-btn:hover {
      color: #ffffff;
    }

    /* Validation error styles */
    input:invalid {
      border-color: red;
      background-color: #ffe6e6;
    }

    .form-group {
      margin-bottom: 15px;
    }

  </style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <h2>IMS Dashboard</h2>
  <a href="/dashboard">Dashboard</a>
  <a href="/reports">Reports</a>
  <a href="/users">Users</a>
  <a href="/settings">Settings</a>
  <a href="/user-management">User Management</a>
  <a href="/item-master">Item Master</a>
  <a href="/profile">Profile</a>
  <a href="/notifications">Notifications</a>
  <a href="/help">Help</a>
  <a href="/reports-overview">Reports Overview</a>
  <a href="/sales-report">Sales Report</a>
  <a href="/inventory-report">Inventory Report</a>
  <a href="/user-roles">User Roles</a>
  <a href="/audit-logs">Audit Logs</a>
  <a href="/system-status">System Status</a>
  <a href="/assign_role_menus">Assign Role Menus</a>
</div>

<div class="main-content" id="mainContent">
  <header>
    <div class="header-left">
      <button class="sidebar-toggle" id="sidebarToggle">&#9776;</button>
      <span>Assign Role Menus</span>
    </div>
    <div class="header-right">
      <span class="user-info">Logged in as: <strong>Rohan</strong></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="top-section">
    <h2>Assign Menus to Role: <span id="roleName">Admin</span></h2>

    <select id="roleSelect" onchange="onRoleChange(this.value)" required>
      <option value="" disabled selected>Select a role</option>
      <option value="Admin">Admin</option>
      <option value="Manager">Manager</option>
      <option value="User">User</option>
    </select>

    <!-- Editable Form -->
    <form id="roleForm" novalidate>
      <div class="form-group">
        <label for="emailInput">Email (required, valid email):</label>
        <input type="email" id="emailInput" name="email" required placeholder="user@example.com" />
      </div>
      <div class="form-group">
        <label for="phoneInput">Phone (required, 10 digits):</label>
        <input type="tel" id="phoneInput" name="phone" pattern="^\d{10}$" required placeholder="1234567890" />
      </div>
      <div class="form-group">
        <label for="ageInput">Age (required, number between 18 and 99):</label>
        <input type="number" id="ageInput" name="age" min="18" max="99" required placeholder="18" />
      </div>
      <div class="form-group">
        <label for="usernameInput">Username (required, alphanumeric, 3-15 chars):</label>
        <input type="text" id="usernameInput" name="username" pattern="^[a-zA-Z0-9]{3,15}$" required placeholder="username123" />
      </div>
    </form>

    <div id="expandCollapseControls">
      <button type="button" onclick="expandAll()">Expand All</button>
      <button type="button" onclick="collapseAll()">Collapse All</button>
    </div>

    <ul id="menuTree"></ul>

    <button class="save-btn" id="saveBtn" disabled onclick="submitAccess()">Save Access</button>
  </div>

  <footer>
    &copy; 2025 Inventory Management System. All rights reserved.
  </footer>
</div>

<script>
  const menuStructure = [
    {
      id: "dashboard",
      label: "Dashboard"
    },
    {
      id: "reports",
      label: "Reports",
      children: [
        { id: "sales", label: "Sales" },
        { id: "inventory", label: "Inventory" }
      ]
    },
    {
      id: "users",
      label: "Users",
      children: [
        {
          id: "create-user",
          label: "Create User",
          children: [
            { id: "user-admin", label: "Admin" },
            { id: "user-manager", label: "Manager" }
          ]
        }
      ]
    }
  ];

  // Sidebar toggle logic
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');
  const sidebarToggle = document.getElementById('sidebarToggle');

  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('visible');
    mainContent.classList.toggle('shifted');
  });

  // Create menu tree with access rights checkboxes
  function createMenu(menuList, container) {
    menuList.forEach(menu => {
      const li = document.createElement("li");

      if (menu.children) {
        const toggleBtn = document.createElement("span");
        toggleBtn.textContent = "+";
        toggleBtn.className = "toggle-btn";
        toggleBtn.onclick = () => {
          const childUl = li.querySelector("ul");
          const isHidden = childUl.style.display === "none";
          childUl.style.display = isHidden ? "block" : "none";
          toggleBtn.textContent = isHidden ? "−" : "+";
        };
        li.appendChild(toggleBtn);
      } else {
        const spacer = document.createElement("span");
        spacer.style.display = "inline-block";
        spacer.style.width = "13px";
        li.appendChild(spacer);
      }

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = menu.id;

      const label = document.createElement("label");
      label.htmlFor = menu.id;
      label.textContent = " " + menu.label;

      li.appendChild(checkbox);
      li.appendChild(label);

      const rightsSpan = document.createElement("span");
      rightsSpan.className = "access-rights";
      ["r", "w", "d"].forEach(right => {
        const rightLabel = document.createElement("label");
        const rightCheckbox = document.createElement("input");
        rightCheckbox.type = "checkbox";
        rightCheckbox.id = `${menu.id}-${right}`;
        rightLabel.appendChild(rightCheckbox);
        rightLabel.appendChild(document.createTextNode(" " + right.toUpperCase()));
        rightsSpan.appendChild(rightLabel);
      });
      li.appendChild(rightsSpan);

      if (menu.children) {
        const ul = document.createElement("ul");
        ul.className = "menu-item";
        ul.style.display = "none";
        createMenu(menu.children, ul);
        li.appendChild(ul);
      }

      container.appendChild(li);
    });
  }

  // Flatten menus for data gathering
  function flattenMenus(menus) {
    let access = [];
    menus.forEach(menu => {
      access.push({
        menu: menu.label,
        id: menu.id,
        checked: document.getElementById(menu.id).checked,
        rights: {
          read: document.getElementById(`${menu.id}-r`).checked,
          write: document.getElementById(`${menu.id}-w`).checked,
          delete: document.getElementById(`${menu.id}-d`).checked
        }
      });
      if (menu.children) {
        access = access.concat(flattenMenus(menu.children));
      }
    });
    return access;
  }

  // Submit access data
  function submitAccess() {
    if (!validateForm()) return;

    const role = document.getElementById("roleName").textContent;
    const access = flattenMenus(menuStructure);

    // Get form data
    const formData = {
      email: document.getElementById("emailInput").value,
      phone: document.getElementById("phoneInput").value,
      age: document.getElementById("ageInput").value,
      username: document.getElementById("usernameInput").value
    };

    fetch("/save_role_menu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ role: role, access: access, formData: formData })
    })
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => console.error("Error:", err));
  }

  // Load saved access for role
  function loadAccessForRole(roleName) {
    // Reset checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

    fetch(`/get_role_menu?role=${roleName}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          if (document.getElementById(item.id)) {
            document.getElementById(item.id).checked = item.checked;
            document.getElementById(`${item.id}-r`).checked = item.rights.read;
            document.getElementById(`${item.id}-w`).checked = item.rights.write;
            document.getElementById(`${item.id}-d`).checked = item.rights.delete;
          }
        });
      });

    // Clear and reset form inputs on role change
    document.getElementById('roleForm').reset();
    validateForm();
  }

  // Handle role change
  function onRoleChange(roleName) {
    if (!roleName) return;
    document.getElementById("roleName").textContent = roleName;
    loadAccessForRole(roleName);
  }

  // Logout function
  function logout() {
    fetch('/logout', { method: 'POST' }).then(() => location.href = '/login');
  }

  // Expand/Collapse all menus
  function expandAll() {
    document.querySelectorAll('#menuTree ul.menu-item').forEach(ul => {
      ul.style.display = 'block';
      const toggle = ul.parentElement.querySelector(".toggle-btn");
      if (toggle) toggle.textContent = "−";
    });
  }

  function collapseAll() {
    document.querySelectorAll('#menuTree ul.menu-item').forEach(ul => {
      ul.style.display = 'none';
      const toggle = ul.parentElement.querySelector(".toggle-btn");
      if (toggle) toggle.textContent = "+";
    });
  }

  // Form validation and enabling/disabling Save button
  const form = document.getElementById('roleForm');
  const saveBtn = document.getElementById('saveBtn');

  function validateForm() {
    const isValid = form.checkValidity();
    saveBtn.disabled = !isValid;
    return isValid;
  }

  form.addEventListener('input', validateForm);
  form.addEventListener('change', validateForm);

  // Initialize
  createMenu(menuStructure, document.getElementById("menuTree"));
  document.getElementById('roleSelect').value = "Admin";
  onRoleChange("Admin");
  validateForm();
</script>

</body>
</html>
